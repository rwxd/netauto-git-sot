# Generated by Ansible

# Defaults

auto mgmt
iface mgmt
    vrf-table auto
    address 127.0.0.1/8
    address ::1/128

auto eth0
iface eth0 inet dhcp
    alias Management
    vrf mgmt
    post-up sysctl -w net.ipv6.conf.eth0.accept_ra=2

# Loopbacks
{% for interface in lookup('topology', 'interfaces') %}
    {% if interface.type.name == 'loopback' %}
auto {{ interface.name }}
iface {{ interface.name }} inet loopback
        {% if interface.description %}
    alias {{ interface.description }}
        {% endif %}

    {% endif %}
{% endfor %}

# Physical Ports
{% for interface in lookup('topology', 'interfaces') %}
    {% if interface.type.name == 'ethernet' %}
auto {{ interface.name }}
iface {{ interface.name }}
        {% if interface.description %}
    alias {{ interface.description }}
        {% endif %}
        {% if interface.mtu %}
    mtu {{ interface.mtu }}
        {% endif %}
        {% if not interface.enabled %}
    link-down yes
        {% endif %}
        {% if interface.untagged_vlan %}
    bridge-access {{ interface.untagged_vlan }}
        {% endif %}
        {% if interface.tagged_vlans %}
    bridge-vids {% for vlan in interface.tagged_vlans %}{{ vlan }}{% if not loop.last %},{% endif %}{% endfor %}
        {% endif %}

    {% endif %}
{% endfor %}

# VLANs
{% for interface in lookup('topology', 'interfaces') %}
    {% if interface.type.name == 'virtual' %}
auto {{ interface.name }}
iface {{ interface.name }}
    {% if interface.description %}
    alias {{ interface.description }}
    {% endif %}
    {% for ip in interface.adresses %}
    address {{ ip.address }}
    {% endfor %}
    vlan-raw-device bridge
    {% if interface.vrf %}
    vrf {{ interface.vrf }}
    {% endif %}

    {% endif %}
{% endfor %}

# VXLANs
{% for vxlan in lookup('topology', 'vxlans') %}
auto vni{{ vxlan.vni }}
iface vni{{ vxlan.vni }}
    bridge-access {{ vxlan.vlan }}
    vxlan-id {{ vxlan.vni }}
    vxlan-local-tunnelip {{ ((lookup('topology', 'interfaces') | selectattr("type.name", "eq", "loopback") | first).addresses | first).address }}


{% endfor %}
# VRFs

auto bridge
iface bridge

